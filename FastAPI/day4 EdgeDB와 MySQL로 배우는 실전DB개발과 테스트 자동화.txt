
-------------------------------------------------
Day4 EdgeDBì™€ MySQLë¡œ ë°°ìš°ëŠ” ì‹¤ì „ DBê°œë°œê³¼ í…ŒìŠ¤íŠ¸ ìë™í™”
-------------------------------------------------

## ch32 Dockerë¥¼ ì´ìš©í•˜ì—¬ MySQLì„œë²„ ì‹¤í–‰í•˜ê¸°

ì°¸ì¡°
notion/part2/Mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°/(mysql) ë„ì»¤ë¡œ Mysql8 ì„¤ì¹˜

Mysql ì„¤ì¹˜
- (mysql) ë„ì»¤ë¡œ Mysql8 ì„¤ì¹˜

    ë„ì»¤ë¡œ mysql 8 ì„ ì„¤ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

    ì´ë¯¸  mysql ì´ ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ì‹  ë¶„ì€ ê±´ë„ˆ ë›°ì…”ë„ ë©ë‹ˆë‹¤.

    `lsof -i:3306`

    `docker run --name mydb -e MYSQL_ROOT_PASSWORD=1234 -d -p 3306:3306 mysql:8`

    - `-e MYSQL_ROOT_PASSWORD=1234` í™˜ê²½ë³€ìˆ˜ë¡œ root password ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
    - `-d` ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
    - `-p 3306:3306` docker container ì˜ 3306 í¬íŠ¸ì™€ í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì˜ 3306 í¬íŠ¸ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.

    ## Pycharm ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°

    Docker desktop í˜¹ì€ orb stack ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì¼œì§„ê²ƒì„ í™•ì¸í–ˆë‹¤ë©´ pycharm ìœ¼ë¡œ ì—°ê±¸í•©ë‹ˆë‹¤.

    `SELECT VERSION();`

    í›„ major ê°€ 8ë¡œ ì‹œì‘í•œë‹¤ë©´ ì„±ê³µì…ë‹ˆë‹¤!


## ch35 [MySQL Ver.]PyTest, Tortoise-ORMì„ í™œìš©í•œ TestCode ì‘ì„±ë²•

ì°¸ì¡°
notion/part2/Mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°/(mysql) tortoise-orm, cryptography, aerich ì„¤ì¹˜. ëª¨ë¸ ìƒì„±

Mysqlë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°
poetry add "tortoise-orm[asyncmy]==0.23.0"
poetry add cryptography==44.0.0
poetry add aerich==0.8.1 tomlkit==0.13.2
poetry add pydantic_settings==2.7.1

https://tortoise.github.io/

- tortoise-orm: django orm ì´ async ë¥¼ (ì˜) ì§€ì›í•˜ì§€ ì•Šë˜ ì‹œì ˆ, ì´ë¥¼ ëŒ€ì‹ í•˜ê¸° ìœ„í•´ íƒ„ìƒí•œ orm ì…ë‹ˆë‹¤.
- cryptography: ë¹„ë°€ë²ˆí˜¸ ë°©ì‹ìœ¼ë¡œ mysql ì— ë¡œê·¸ì¸ í•  ë–„ í•„ìš”í•©ë‹ˆë‹¤.
- aerich: tortoise-orm ì˜ migration tool ì…ë‹ˆë‹¤. (sqlalchemy ì— alembic ì´ ìˆë‹¤ë©´ tortoise ì—ëŠ” aerich ê°€ ìˆìŠµë‹ˆë‹¤.)
- pydantic_settings: ì„œë²„ ë™ì‘ì— í•„ìš”í•œ ë³€ìˆ˜ë“¤ì„ í™˜ê²½ë³€ìˆ˜ì—ì„œ ì½ì–´ì£¼ê±°ë‚˜ dot env ì—ì„œ ì½ì–´ì¤ë‹ˆë‹¤. ì›ë˜ pydantic v1 ì—ì„œëŠ” pydantic ìì²´ì— í¬í•¨ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜€ëŠ”ë°, v2 ê°€ ë˜ë©´ì„œ ë¹ ì ¸ë‚˜ì™”ìŠµë‹ˆë‹¤. pydantic ì´ê¸° ë•Œë¬¸ì— ì—­ì‹œ íƒ€ì… ê´€ë ¨ ê¸°ëŠ¥ì´ ê°•ë ¥í•©ë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ë¥¼ ì ì ˆí•œ â€œíŒŒì´ì¬ íƒ€ì…â€ ìœ¼ë¡œ ë³€í™˜ì‹œì¼œì¤ë‹ˆë‹¤.
- tomlkit: (aerich ë²„ê·¸ ë•Œë¬¸ì— ì„¤ì¹˜í•©ë‹ˆë‹¤ ğŸ˜­) aerich ê°€ ì˜ì¡´í•¨ì—ë„ ë¶ˆêµ¬í•˜ê³  ì˜ì¡´ì„± ê·¸ë˜í”„ì— ì—†ê¸° ë•Œë¬¸ì— ìˆ˜ë™ìœ¼ë¡œ ì„¤ì°¨í™ë‹ˆë‹¤.

ORMì€ Object-Relational Mappingì˜ ì•½ìë¡œ,
ê°ì²´ ì§€í–¥ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë‹¤ë£° ë•Œ ì‚¬ìš©í•˜ëŠ” ê¸°ìˆ 

ê¸°ìœ ì†Œì‹: tortoise-orm ì€ ì‚¬ìš© ë°©ë²•ì´ django orm ê³¼ 90% í¡ì‚¬í•©ë‹ˆë‹¤.

- ëª¨ë¸ ì„ ì–¸ë°©ì‹
- QuerySet ì„ ì‚¬ìš©í•´ì„œ ì¿¼ë¦¬í•˜ëŠ” ì 
- Orm ì„ ìœ„í•œ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ë¥¼ ì œê³µí•˜ëŠ” ì 
ì´ ê±°ì˜ ë˜‘ê°™ìŠµë‹ˆë‹¤!

pydanticì˜ ê¸°ëŠ¥
í˜„ì¬ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ .envê°€ ìˆìœ¼ë©´ ì½ê³  ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ì„ ë¶ˆëŸ¬ì˜´.
.envì— ENV="invalid" ì´ë ‡ê²Œ ë³€ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ”ë°.
configì— ë¯¸ë¦¬ ì •ì˜í•œ enum envì˜ ê°’ìœ¼ë¡œ 'local', 'stage', 'prod' ì´ë ‡ê²Œ ì •í•´ì ¸ìˆê¸° ë•Œë¬¸ì—
ENV ê°’ì´ invalidì´ë ‡ê²Œ ë˜ì–´ ìˆìœ¼ë©´ ì—ëŸ¬ê°€ ë‚œë‹¤.


# mainí•˜ê³  ìë™ì™„ì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ë§Œë“¤ì–´ì¤Œ.
# íŒŒì´ì°¸ì˜ ë¼ì´ë¸Œ í…œí”Œë¦¿ ê¸°ëŠ¥

# íŒŒì¼ë©”ë‰´ í´ë¦­ ëŸ° ìœ¼ë¡œ í•´ë‹¹ íŒŒì¼ì„ ì‹¤í–‰
# í˜¹ì€ ì»¨íŠ¸ë¡¤ ì‹œí”„íŠ¸ rë¡œ í•´ë‹¹ íŒŒì¼ì„ ì‹¤í–‰

# ì»¤ë§¨ë“œ ì‹œí”„íŠ¸ n  ìŠ¤í¬ë˜ì¹˜ íŒŒì¼ ìƒì„±

# Swagger UI   http://localhost:8000/docs    ëŒ€í™”í˜• API ë¬¸ì„œ (ê¸°ë³¸ ì œê³µ)
# ReDoc        http://localhost:8000/redoc   ê¹”ë”í•œ ìŠ¤íƒ€ì¼ì˜ API ë¬¸ì„œ


--------------
Replication
--------------

Replication ì „ëµì€
ì£¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œì—ì„œ ë°ì´í„°ì˜ ë³µì œ ë°©ì‹ì„ ì •í•˜ëŠ” ì „ëµì„ ë§í•©ë‹ˆë‹¤.
ë°ì´í„°ì˜ ê°€ìš©ì„±, ì•ˆì •ì„±, í™•ì¥ì„±ì„ ë†’ì´ê¸° ìœ„í•´ì„œ ì—¬ëŸ¬ ì„œë²„ì— ë™ì¼í•œ ë°ì´í„°ë¥¼ ë³µì œí•˜ëŠ” ë°©ì‹.

ì“°ê¸°, ìˆ˜ì •, ì‚­ì œ ì‘ì—… ìš©ë„ì˜ DBë¥¼ í•˜ë‚˜ ì“°ê³  (writeDB)
ì½ê¸° ì „ìš© DBë¥¼ ì“´ë‹¤.  (read replica DB)

ë³´í†µ ì½ê¸° ì‘ì—…ì´ ë§ê¸° ë•Œë¬¸ì— ì´ëŸ° ì „ëµì„ ì‚¬ìš©í•˜ê¸°ë„ í•œë‹¤.

- `connect_timeout: 5` ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°ì„ ì‹œë„í•œ ë’¤,
5ì´ˆ ì´ë‚´ì— ë°ì´í„°ë² ì´ìŠ¤ê°€ ì‘ë‹µí•˜ì§€ ì•Šì„ ê²½ìš° ê¸°ë‹¤ë¦¬ëŠ” ê²ƒì„ ë©ˆì¶˜ í›„ timeout error ë¥¼ ì¼ìœ¼í‚µë‹ˆë‹¤.

- `maxsize: 30` ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°ì„ ë§ºëŠ”ì¼ì€ ì‹œê°„ì  ë¹„ìš©ì´ ë§ì´ ë“œëŠ” ì‘ì—…ì…ë‹ˆë‹¤.
ì–´ì§œí”¼ ë°ì´í„°ë² ì´ìŠ¤ì™€ëŠ” ìì£¼ ì†Œí†µí•˜ê¸° ë•Œë¬¸ì— ë§¤ ë²ˆ ì—°ê²°ì„ ìƒˆë¡œ ë§ºëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ê¸°ì¡´ì— ë§ºì–´ë‘ì—ˆë˜ ì—°ê²°ì„ ì¬í™œìš© í•¨ìœ¼ë¡œì¨ íš¨ìœ¨ì ìœ¼ë¡œ í†µì‹ í•©ë‹ˆë‹¤.
ì´ë¥¼ â€œì»¤ë„¥ì…˜ í’€â€ ì´ë¼ê³  í•˜ë©°, `maxsize` ëŠ” ì»¤ë„¥ì…˜ í’€ì´ ìµœëŒ€ë¡œ ê°€ì§€ê³  ìˆì„ ìˆ˜ ìˆëŠ” connection ì˜ ìˆ˜ ì…ë‹ˆë‹¤.

ì»¤ë„¥ì…˜ í’€(Connection Pool)ì€
ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ê¸°ìˆ .
DBì™€ì˜ ì—°ê²°(Connection)ì€ ë§Œë“œëŠ” ë° ë¹„ìš©ì´ í¬ê³  ëŠë¦¬ê¸° ë•Œë¬¸ì—,
DB ì—°ê²°ì„ ë¯¸ë¦¬ ë§Œë“¤ì–´ í’€(pool)ì— ë³´ê´€í•˜ê³ , í•„ìš”í•  ë•Œ êº¼ë‚´ ì“°ëŠ” ë°©ì‹.

ë³´í†µ gunicorn ì€ â€œë©€í‹° í”„ë¡œì„¸ìŠ¤â€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
ê° worker ê°€ ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ì…ë‹ˆë‹¤.
ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ì¸ worker ë“¤ì€ ì»¤ë„¥ì…˜ í’€ì„ ê³µìœ í•˜ì§€ ì•Šê³  ì €ë§ˆë‹¤ ê°ìì˜ ì»¤ë„¥ì…˜ í’€ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
ë”°ë¼ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ìµœëŒ€ë¡œ ë§ºì–´ì§ˆ ìˆ˜ ìˆëŠ” ì»¤ë„¥ì…˜ì˜ ìˆ˜ëŠ” = ì»¤ë„¥ì…˜ í’€ì˜ max size * worker ì˜ ìˆ˜ ì…ë‹ˆë‹¤.

connection ì˜ ê°œìˆ˜ê°€ ë§ì„ ìˆ˜ë¡ íŠ¸ë˜í”½ì´ ê°‘ì‘ìŠ¤ëŸ½ê²Œ ìŸì•„ì§ˆë•Œ ë” ìœ ì—°í•˜ê²Œ ëŒ€ì²˜ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤ë§Œ,
ë°˜ëŒ€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ë©”ëª¨ë¦¬ë„ ë§ì•„ì§„ë‹¤ëŠ” ì  ìœ ë…í•´ ë‘¡ì‹œë‹¤.


# MySQL : primary keyë¥¼ ì •í•  ë•Œ ì£¼ì˜í•´ì•¼ ë˜ëŠ” ì 
# MySQL version 8 ì´ìƒ ë¶€í„°ë¼ë©´ (5.7 ë¶€í„°ë„ ì“°ê¸´í•¨)
# innodbê°€ default engine (ì˜›ë‚  MyISAM)

# innodbì˜ íŠ¹ì§• ì¤‘ í•˜ë‚˜ ->  clustering index
# primary keyë¥¼ ê¸°ì¤€ìœ¼ë¡œ
# primary keyê°’ì´ ë¹„ìŠ·í•œ rowë“¤ë¼ë¦¬ diskì—ì„œë„ ì‹¤ì œë¡œ ëª¨ì—¬ìˆìŒ.

# HDD
# ëœë¤ IOê°€ ëŠë¦¬ê³ , ìˆœì°¨ IOê°€ ë¹ ë¥´ë‹¤.

# SSD
# ìˆœì°¨ IOê°€ ì¢€ ë” ë¹ ë¥´ì§€ë§Œ ëœë¤ IOë„ ë¹ ë¦„.

# ê·¸ëƒ¥ intê°€ ì•„ë‹ˆë¼, ë¹„ì¦ˆë‹ˆìŠ¤ ì‘ ì˜ë¯¸ê°€ ìˆê³ 
# ê³„ì†í•´ì„œ ì¦ê°€í•˜ëŠ” ì–´ë–¤ ê°‘ìœ¼ë¡œ ì„¤ì •í•˜ë©´
# êµ‰ì¥íˆ ë¹ ë¥´ê²Œ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# intì˜ ìµœëŒ€ê°’ 21ì–µì´ì§€ë§Œ ì´ê±¸ ë„˜ì–´ì„œ ì‚¬ìš©í•˜ê²Œ ë  ìˆ˜ë„ ìˆì–´ì„œ bigintì‚¬ìš©


## ch34 aerichë¥¼ í™œìš©í•œ Metting Model ë§ˆì´ê·¸ë ˆì´ì…˜


tortoise_models/meeting.py ì‘ì„±

# ì•„ì§ ì •ì˜ ë˜ì§€ ì•Šì€ ëª¨ë¸ì— ëŒ€í•œ ì˜¤ë¥˜ ì„ì‹œ í•´ê²°
# async def create_meeting(cls, url_code: str) -> MeetingModel:  # MeetingModelì •ì˜ê°€ ì•„ì§ ëë‚˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì—ëŸ¬ë‚¨.
async def create_meeting(cls, url_code: str) -> "MeetingModel":  # ìŒë”°ì˜´í‘œë¥¼ ì‚¬ìš©í•´ ì„ì‹œë¡œ ì—ëŸ¬ í•´ê²°.

# Text : ê¸¸ì´ê°€ ê¸¸ë‹¤. ì¸ë±ìŠ¤ ì•ˆë¨.
# Varchar : ê¸¸ì´ ì œí•œ, ì¸ë±ìŠ¤ ê°€ëŠ¥.
# mysqlì˜ varcherëŠ” 255ì´í•˜ëŠ” ì‚¬ìš©ë˜ëŠ” í¬ê¸°ê°€ ê°™ë‹¤.

ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ê¸° ìœ„í•´ ì´ˆê¸°í™”
aerich init -t app.configs.tortoise_config.TORTOISE_ORM

ì´ˆê¸°í™” í›„ pyproject.tomlì— ì„¤ì •ì´ ìƒê¹€.

dbì´ˆê¸°í™”
aerich init-db
ì•ˆë ì‹œ dbì„¤ì • í™•ì¸.

migrations.modelsí´ë”ì— ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ ìƒê¹€.
ì¿¼ë¦¬ê°€ ì €ì¥ë˜ì–´ ìˆìŒ.


Alembic
ORMì„ ë°”ê¾¸ë ¤ê³  í•  ë•Œ ëŒ€ê³µì‚¬ë¥¼ í•˜ê²Œ ë  ìˆ˜ë„ ìˆìŒ.

Aerich
DBë¥¼ ë°”ê¿€ë•Œ ì¿¼ë¦¬ë¬¸ì„ ìˆ˜ì •í•´ì•¼í•¨.

ë§ˆì´ê·¸ë ˆì´íŠ¸
aerich migrate

Databaseí™•ì¸
ìƒˆë¡œê³ ì¹¨ í›„ -> meeting -> modify table
í•„ë“œ ì œëŒ€ë¡œ ë§Œë“¤ì–´ì¡Œë‚˜ í™•ì¸


## ch35 [MySQL Ver.]PyTest, Tortoise-ORMì„ í™œìš©í•œ TestCode ì‘ì„±ë²•

ì°¸ì¡°
notion/part2/Mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°/tortoise-orm, cryptography, aerich ì„¤ì¹˜. ëª¨ë¸ ìƒì„±
notion/part2/Mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°/(mysql) httpx ì„¤ì¹˜, í…ŒìŠ¤íŠ¸ ì‘ì„±í•˜ê¸°

https://tortoise.github.io/contrib/unittest.html?h=conftest.py#py-test

initializer - ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±ê³¼ ì—°ê²° ìˆ˜ë¦½
finalizer - ë‚¨ì•„ìˆëŠ” ì—°ê²°ì„ ì „ë¶€ ì¢…ë£Œ(ì»¤ë„¥ì…˜ ì¢…ë£Œ)

ìµœìƒìœ„/conftest.py ìƒì„±
pytestëŠ” í”„ë¡œì íŠ¸ ìµœìƒë‹¨ì— ìˆëŠ” conftest.py ìë™ìœ¼ë¡œ ì½ìŒ

TEST_BASE_URL = "http://test"
TEST_DB_LABEL = "models"  # í…ŒìŠ¤íŠ¸í•  DB model
TEST_DB_TZ = "Asia/Seoul"  # íƒ€ì„ì¡´ ì„¤ì •

def get_test_db_config() -> dict[str, Any]:
    tortoise_config = generate_config(
        db_url=f"mysql://{config.MYSQL_USER}:{config.MYSQL_PASSWORD}@{config.MYSQL_HOST}:{config.MYSQL_PORT}/test",
        app_modules={TEST_DB_LABEL: TORTOISE_APP_MODELS},
        connection_label=TEST_DB_LABEL,
        testing=True,  # testDB ìë™ ìƒì„±í•´ì¤Œ
    )
    tortoise_config["timezone"] = TEST_DB_TZ

    return tortoise_config

# autouseê°€ í™œì„±í™” ë˜ì–´ ìˆìœ¼ë©´ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ fixtureê°€ ìƒì„±ë¨.
@pytest.fixture(scope="session", autouse=True)
def initialize(request: FixtureRequest) -> Generator[None, None]:
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    # Mockingì€ ì‹¤ì œ ì˜ì¡´ì„±ì„ ëŒ€ì²´í•  ê°€ì§œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²ƒ
    with patch("tortoise.contrib.test.getDBConfig", Mock(return_value=get_test_db_config())):
        initializer(modules=TORTOISE_APP_MODELS)  # ì»¤ë§¨ë“œ p ëˆŒëŸ¬ë³´ë©´ ì¸ìê°€ ë³´ì„
    yield  # ì¢…ë£Œë  ë•Œ í˜¸ì¶œë¨.
    finalizer()  # yieldê°€ ì—†ëŠ” ì¼ë°˜ fixtureëŠ” í…ŒìŠ¤íŠ¸ê°€ ì²˜ìŒ ì‹œì‘í•  ë•Œ í•œë²ˆí˜¸ì¶œë˜ê³  ì¢…ë£Œë  ë•Œ í˜¸ì¶œì•ˆë¨.
    loop.close()

# í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ì—ì„œ fixture ì´ë¦„ì„ ì¸ìë¡œ ë°›ìœ¼ë©´ initializeë¥¼ ê°€ë™ì‹œí‚´
# def test_func(initialize):
#     pass

# pytestëŠ” async í•¨ìˆ˜ë¥¼ ì›ë˜ëŠ” í•  ìˆ˜ ì—†ìŒ.
# pytest-asyncioë¥¼ ì„¤ì¹˜í•˜ë©´ pytestë„ asyncí•¨ìˆ˜ë¥¼ ì‹¤í–‰ í•  ìˆ˜ ìˆìŒ.
# pytest-asyncioì˜ event loopì™€ tortoiseì˜ event_loopê°€ ì¶©ëŒí•˜ëŠ” ê²ƒì„ í”¼í•˜ê¸° ìœ„í•´
# pytest-asyncioì˜ event loopë¥¼ ì¬ì •ì˜. (ê¸°ë³¸ ë™ì‘ì„ ì—†ì•°)
@pytest_asyncio.fixture(autouse=True, scope="session")
def event_loop() -> None:
    pass

**Mocking(ëª¨í‚¹)**ì€
í…ŒìŠ¤íŠ¸ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ê°œë…ìœ¼ë¡œ,
ì–´ë–¤ ê°ì²´ë‚˜ í•¨ìˆ˜ì˜ ì‹¤ì œ ë™ì‘ì„ í‰ë‚´ ë‚´ëŠ” ê°€ì§œ(mock) ê°ì²´ë¥¼ ë§Œë“œëŠ” ê²ƒ

- `initialize()`
pytest fixture ë¡œ, scope ê°€ session ì´ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ ì‹œì‘ê³¼ í•¨ê»˜ ìƒì„±ë˜ê³ ,
ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì¢…ë£Œëœ ì´í›„ì— yield ì´í›„ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. tortoise ë¥¼ ì¤€ë¹„ì‹œí‚¤ëŠ” ì—­í• ê³¼,
í…ŒìŠ¤íŠ¸ ì¢…ë£Œí›„ ë‚¨ì€ connection ì„ ì •ë¦¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

- `event_loop()` ë‚˜ìœ ì§“(?) ì´ê¸´ í•˜ì§€ë§Œ ì˜ë„ì ìœ¼ë¡œ pytest-asyncio ì˜ event loop ìƒì„±ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.
ì´ëŠ” tortoise-orm ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.

ì£¼ì˜: tortoise ëŠ” async library ì„ì—ë„ ë¶ˆêµ¬í•˜ê³  pytest-asyncio ë¥¼ ìƒì •í•˜ì§€ ì•Šê³  ë§Œë“¤ì–´ ì¡ŒìŠµë‹ˆë‹¤.
í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ìì²´ëŠ” async ë¡œ ì‘ì„±í•  ìˆ˜ ìˆì§€ë§Œ, pytest ëŠ” sync í•¨ìˆ˜ë¡œ ì¸ì‹í•©ë‹ˆë‹¤.
pytest-asyncio ëŠ” async í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ìŠ¤ìŠ¤ë¡œ event loop ë¥¼ ìƒì„±í•˜ëŠ”ë°ìš”,
ë¬¸ì œëŠ” tortoise í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ê°€ ìƒì„±í•˜ëŠ” ì´ë²¤íŠ¸ ë£¨í”„ì™€ ì„œë¡œ ì¶©ëŒí•©ë‹ˆë‹¤! (ì´ ë¬¸ì œë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•´ pytest-asyncio ê°€ event loop ë¥¼ ìƒì„±í•˜ì§€ ëª»í•˜ë„ë¡ ì°¨ë‹¨í•˜ê² ìŠµë‹ˆë‹¤.)
ì œì¼ ì¢‹ì€ ë°©ë²•ì€ tortoise ê°€ pytest-asyncio ë¥¼ ì§€ì›í•´ ì£¼ëŠ” ê²ƒì¸ë°â€¦ ë²„ì „ ì—…ë°ì´íŠ¸ë¥¼ ê³„ì† ê¸°ë‹¤ë¦´ ìˆ˜ëŠ” ì—†ìœ¼ë¯€ë¡œ,
ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ ì°¨ë‹¨í•˜ëŠ” ê¼¼ìˆ˜(?) ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.


ì„¤ì •ì´ ëë‚¬ë‹¤ë©´ httpxë¥¼ ì„¤ì¹˜í•œ í›„ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ ì‘ì„±
poetry add httpx
poetry add httpx==0.28.1

DRF(Django Rest Framework)ë§Œë“  íŒ€ì´ httpxë„ ë§Œë“¬.

fastapi ê³µì‹ ë¬¸ì„œì˜ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ
https://fastapi.tiangolo.com/advanced/async-tests/#example


# app/tests/apis/v1/test_meeting_router_mysql ì‘ì„±

class TestMeetingRouter(TestCase):
    async def test_api_create_meeting_mysql(self) -> None:  # ëª¨ë“  í…ŒìŠ¤íŠ¸ëŠ” Noneì„ ë°˜í™˜í•˜ëŠ”ê²Œ ì •ì„
        # Given When Then êµ¬ì¡°ì—ì„œ Givenì€ ìë™ìƒì„±ë˜ê¸° ë•Œë¬¸ì— Given ìƒëµ

        # When
        # AsyncClientëŠ” asyncì—°ì‚°ì´ í•„ìš”í•´ì„œ asyncë¥¼ ì‚¬ìš©
        # asyncë¡œ ì—´ë©´ asyncë¡œ ë‹«ì•„ì•¼í•¨.
        async with httpx.AsyncClient(
            transport=httpx.ASGITransport(app=app),
            base_url="http://test",
        ) as client:
            response = await client.post("/v1/mysql/meetings")

        response.raise_for_status() #  ì‘ë‹µ ì½”ë“œê°€ ì—ëŸ¬ì¼ ê²½ìš° ì˜ˆì™¸(Exception)ë¥¼ ë°œìƒì‹œí‚¤ëŠ” í•¨ìˆ˜

        # Then: í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ê²€ì¦
        # API í…ŒìŠ¤íŠ¸ì—ì„œ ì‘ë‹µì´ ì„±ê³µí–ˆëŠ”ì§€(200 OK)ë¥¼ í™•ì¸í•˜ëŠ” ì½”ë“œ
        assert response.status_code == HTTP_200_OK # ì—¬ê¸°ê¹Œì§€ë§Œ í•˜ë©´ ì‹¤ì œë¡œ ë°ì´í„°ê°€ ìƒì„±ë¬ëŠ”ì§€ ê²€ì¦ì´ ì•ˆë¨.
        # API í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ ë°ì´í„° ë³€í™˜ì„ ì‹œë„í•¨. API í…ŒìŠ¤íŠ¸ ì „ì— ì‹œë„í•˜ë©´ ì˜ëª»ëœ ì˜¤ë¥˜ì½”ë“œë¡œ í˜¼ë€ì„ ìœ ë„í•¨.
        url_code = response.json()["url_code"]
        assert (await MeetingModel.filter(url_code=url_code).exists()) is True

# FastAPIëŠ” ASGIì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•¨.
# ASGI ê·œì¹™ëŒ€ë¡œ í˜¸ì¶œí•˜ë©´ ì‹¤ì œë¡œ httpìš”ì²­ì„ í•˜ì§€ ì•Šì•„ë„ ë§ˆì¹˜ httpìš”ì²­ì„ í•œê²ƒì²˜ëŸ¼ ì²˜ë¦¬
# ASGITransport() : ASGI ê·œì¹™ëŒ€ë¡œ í˜¸ì¶œ
#
# SGIë€?
# ASGI (Asynchronous Server Gateway Interface)
# Pythonì—ì„œ ë¹„ë™ê¸° ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìœ„í•œ í‘œì¤€ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
#
# WSGIì˜ ì—…ê·¸ë ˆì´ë“œ ë²„ì „ì…ë‹ˆë‹¤.
# FastAPI, Django Channels, Starlette, uvicorn ë“±ì—ì„œ ì‚¬ìš©ë©ë‹ˆë‹¤.

# êµ¬ë¶„        WSGI                              ASGI
# ëŒ€ìƒ        ë™ê¸° ì›¹ ì•± (Flask, Django ê¸°ë³¸)      ë¹„ë™ê¸° ì›¹ ì•± (FastAPI, Django Channels ë“±)
# ì²˜ë¦¬ ë°©ì‹    í•˜ë‚˜ì˜ ìš”ì²­ ì²˜ë¦¬ í›„ ë‹¤ìŒ ìš”ì²­           ì—¬ëŸ¬ ìš”ì²­ì„ ë¹„ë™ê¸°ë¡œ ë™ì‹œì— ì²˜ë¦¬ ê°€ëŠ¥
# ì˜ˆ         Flask, Django (ê¸°ë³¸)               FastAPI, Django Channels, Starlette
# ë³‘ë ¬ì„±      ì œí•œì                               âœ… ì›¹ì†Œì¼“/HTTP/ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ê°€ëŠ¥

# ì‚¬ìš© ìƒí™©                                     ASGIê°€ í•„ìš”í•œê°€?
# ì¼ë°˜ ì›¹ì‚¬ì´íŠ¸ (ë¸”ë¡œê·¸, ì‡¼í•‘ëª° ë“±)                  âŒ ë³´í†µ WSGIë¡œ ì¶©ë¶„
# ì›¹ì†Œì¼“, ì‹¤ì‹œê°„ ì±„íŒ…, ì•Œë¦¼                        âœ… ASGI í•„ìš”
# FastAPI ì‚¬ìš© ì‹œ                              âœ… ASGI í•„ìš”
# Djangoì—ì„œ Django Channelsë¡œ WebSocket ì“¸ ë•Œ  âœ… ASGI í•„ìš”

# awaitë€?
# awaitëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ (async def) ì•ˆì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í‚¤ì›Œë“œë¡œ,
# ë‹¤ë¥¸ ë¹„ë™ê¸° í•¨ìˆ˜ì˜ ì‹¤í–‰ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

# HTTPëŠ” ë‹¤ì–‘í•œ ì‘ë‹µì„ ì£¼ê³  ë°›ì„ ìˆ˜ ìˆë‹¤.

# with (Context Manager)(ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ì)
# ë¦¬ì†ŒìŠ¤ë¥¼ ì—´ê³  ë‹«ëŠ” ê³¼ì •ì„ ìë™ìœ¼ë¡œ ê´€ë¦¬í•´ì£¼ëŠ” ë§¤ìš° ê°•ë ¥í•œ ë¬¸ë²•ì…ë‹ˆë‹¤.
# ì‘ì—…ì´ ëë‚¬ì„ ë•Œ ìë™ìœ¼ë¡œ ì‘ì—…ì„ ì¢…ë£Œ close()ë¥¼ ì‹œì¼œì¤Œ.
# ì‘ì—…ì´ ëë‚¬ì„ ë•Œ ì‘ì—…ì„ ì¢…ë£Œ close()ë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì´ ì ‘ê·¼ í•  ìˆ˜ ì—†ìŒ.
#
# ëŒ€í‘œì ì¸ ë¦¬ì†ŒìŠ¤ ì˜ˆì‹œ
# ë¦¬ì†ŒìŠ¤ ì¢…ë¥˜           ì˜ˆì‹œ                                                 ì„¤ëª…
# íŒŒì¼                open("file.txt")                                     íŒŒì¼ í•¸ë“¤ (ì½ê¸°/ì“°ê¸° í›„ ë‹«ì•„ì•¼ í•¨)
# ë„¤íŠ¸ì›Œí¬ ì—°ê²°         requests.Session(), socket, FTP                      ì—°ê²° í›„ ì¢…ë£Œí•´ì•¼ í•¨
# ë°ì´í„°ë² ì´ìŠ¤          connection.cursor()                                  ì»¤ì„œ ì—´ê³  ë‹«ê¸° í•„ìš”
# ìŠ¤ë ˆë“œ ë½            threading.Lock()                                     ë½ íšë“ í›„ í•´ì œ í•„ìš”
# ì…ì¶œë ¥ ì¥ì¹˜           serial.Serial(), camera.open()                      ì¥ì¹˜ ì—°ê²°/í•´ì œ
# ë¡œê·¸                loggingì—ì„œ FileHandler, StreamHandler
# ê°€ìƒ í™˜ê²½ / ì„¸ì…˜      Django request, Flask context, transaction.atomic()
# ì„ì‹œ íŒŒì¼/ë””ë ‰í„°ë¦¬     tempfile.NamedTemporaryFile()
# WebDriver          selenium.webdriver.Chrome()                          ë¸Œë¼ìš°ì € ì—´ê³  ë‹«ê¸°


ì´ê²ƒì´ TDD(Test Driven Development) ì…ë‹ˆë‹¤. TDD ëŠ” ë‹¤ìŒ ìˆœì„œë¡œ ê°œë°œì„ í•˜ëŠ” ë°©ë²•ë¡  ì…ë‹ˆë‹¤.

- ìš”êµ¬ì‚¬í•­ì„ ê²€ì¦í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì‘ì„±í•©ë‹ˆë‹¤. (ì‘ë‹µì´ ì œëŒ€ë¡œ ì˜¤ëŠ”ì§€, ë°ì´í„°ë² ì´ìŠ¤ì— ì •ë§ insert ë˜ì—ˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸)
- í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³ , ì‹¤íŒ¨í•˜ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤.
- ìš”êµ¬ì‚¬í•­ì„ ì‹¤ì œë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.
- í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³ , ì„±ê³µí•˜ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤. (ì‹¤íŒ¨í–ˆë‹¤ë©´ êµ¬í˜„ì¤‘ ì–´ë””ì„œ ì‹¤ìˆ˜í–ˆëŠ”ì§€ íŒŒì•…í•œ í›„ ìˆ˜ì •í•©ë‹ˆë‹¤.)

ì •ë¦¬

- pytest ëŠ” í”„ë¡œì íŠ¸ ì œì¼ ìµœìƒìœ„ì˜ [`conftest.py`](http://conftest.py) ë¥¼ ìë™ìœ¼ë¡œ ì½ì–´ë“¤ì¸ë‹¤. ì—¬ê¸°ì„œ ì›í•˜ëŠ” ì„¤ì • + í•„ìš”í•œ fixture ë¥¼ ì •ì˜í•  ìˆ˜ ìˆë‹¤.
- httpx ë¡œ fastapi ì— ëŒ€í•œ async test ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
- í…ŒìŠ¤íŠ¸ ë¨¼ì € ì‘ì„± í•œ ì´í›„ì— êµ¬í˜„ì„ í•˜ëŠ”ê²ƒì´ TDD ì´ë‹¤.

# CI ìˆ˜ì •

  # í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‹¤í–‰ í•  ìˆ˜ë„ ìˆìŒ.
  # - name: Run tests only if test files exist
  # run: |
  # if find . -type f -name 'test_*.py' | grep -q .; then
  # ...
  # else
  # ...

  # ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ í•  ìˆ˜ ìˆëŠ” ì½”ë“œê°€ ìˆëŠ”ì§€ íŒë³„ í›„ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
  - name: Run tests only if tests actually exist
    run: |
      echo "ğŸ” Checking if pytest can collect any tests..."
      TEST_COUNT=$(poetry run pytest --collect-only -q 2>/dev/null | grep -c '::' || true)

      if [ "$TEST_COUNT" -gt 0 ]; then
        echo "âœ… Found $TEST_COUNT tests. Running pytest..."
        poetry run coverage run -m pytest .
        poetry run coverage report -m
      else
        echo "âš ï¸ No runnable tests found. Skipping pytest."
      fi

  # pytest --collect-only : í…ŒìŠ¤íŠ¸ ìˆ˜ì§‘
  # pytest --collect-only -q: í…ŒìŠ¤íŠ¸ ëª©ë¡ë§Œ ì¶œë ¥
  # grep -c '::': í…ŒìŠ¤íŠ¸ ê°œìˆ˜ ì„¸ê¸°
  # poetry run pytest ... || true â†’ í…ŒìŠ¤íŠ¸ ì—†ì–´ì„œ ì‹¤íŒ¨í•´ë„ ì •ìƒ ì¢…ë£Œ ì²˜ë¦¬ (ìµœì¢… ì¢…ë£Œ ì½”ë“œëŠ” 0)
  # grep -c '::'ë¡œ ì‹¤ì œ ìˆ˜ì§‘ ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ê°œìˆ˜ë¥¼ ì •í™•íˆ íŒë³„

  # í…ŒìŠ¤íŠ¸ê°€ ì—†ëŠ” ê²½ìš° pytestëŠ” ì¢…ë£Œ ì½”ë“œë¥¼ 5ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤ â†’ "ìˆ˜í–‰í•  í…ŒìŠ¤íŠ¸ê°€ ì—†ìŒ"
  # GitHub ActionsëŠ” 0ì´ ì•„ë‹Œ ëª¨ë“  ì¢…ë£Œ ì½”ë“œë¥¼ ì‹¤íŒ¨ë¡œ ê°„ì£¼

  # pytest ì¢…ë£Œ ì½”ë“œ (exit code)
  # 0	í…ŒìŠ¤íŠ¸ ì„±ê³µ (ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼)
  # 1	í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì–´ë–¤ í…ŒìŠ¤íŠ¸ë“  ì‹¤íŒ¨í•¨)
  # 2	ì‚¬ìš©ë²• ì—ëŸ¬ (ì˜ˆ: ì˜ëª»ëœ ì¸ì)
  # 3	ë‚´ë¶€ ì—ëŸ¬
  # 4	pytest í”ŒëŸ¬ê·¸ì¸ ì—ëŸ¬
  # 5	í…ŒìŠ¤íŠ¸ ì—†ìŒ (no tests collected)


## ch36 [MySQL Ver.]MySQLë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°

ì°¸ì¡°
notion/part2/Mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°/(mysql) mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°

## ch37

ì°¸ì¡°
notion/part2/Mysql ë¡œ meeting ìƒì„± êµ¬í˜„í•˜ê¸°/(mysql) ci ì— mysql ì¶”ê°€
